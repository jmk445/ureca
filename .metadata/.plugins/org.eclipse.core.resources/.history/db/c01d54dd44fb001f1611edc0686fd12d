package app.phone.ui;

import java.awt.*;
import javax.swing.*;
import javax.swing.event.*;
import javax.swing.table.*;
import java.util.List;

import app.phone.dao.PhoneDao;
import app.phone.dao.OrderDao;
import app.phone.dto.Phone;
import app.phone.dto.Order;

public class AdminDialog extends JDialog {

    private JTable phoneTable;
    private DefaultTableModel phoneTableModel;
    private JTable orderTable;
    private DefaultTableModel orderTableModel;

    private PhoneDao phoneDao = new PhoneDao();
    private OrderDao orderDao = new OrderDao();
    private List<Phone> phoneList;
    private List<Order> orderList;

    public AdminDialog(MallManager parent) {
        super(parent, "ê´€ë¦¬ì í˜ì´ì§€", true);
        setSize(700, 500);
        setLocationRelativeTo(parent);

        // 1. íœ´ëŒ€í° ëª©ë¡ í…Œì´ë¸” (í¸ì§‘ ê°€ëŠ¥)
        phoneTableModel = new DefaultTableModel(new Object[]{"ëª¨ë¸ëª…", "ê°€ê²©(ì›)", "ì œì¡°ì‚¬", "ì¬ê³ "}, 0) {
            @Override
            public boolean isCellEditable(int row, int column) {
                return column != 0; // ëª¨ë¸ëª…ì€ ìˆ˜ì • ë¶ˆê°€, ë‚˜ë¨¸ì§€ëŠ” ìˆ˜ì • ê°€ëŠ¥
            }
        };
        phoneTable = new JTable(phoneTableModel);
        listPhones(); // íœ´ëŒ€í° ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°

        // ğŸ”¥ í…Œì´ë¸” ë³€ê²½ ê°ì§€ í›„ DB ì—…ë°ì´íŠ¸
        phoneTableModel.addTableModelListener(new TableModelListener() {
            @Override
            public void tableChanged(TableModelEvent e) {
                if (e.getType() == TableModelEvent.UPDATE) {
                    int row = e.getFirstRow();
                    updatePhoneInfo(row);
                }
            }
        });

        // 2. ì£¼ë¬¸ ê¸°ë¡ í…Œì´ë¸” (ìƒì„¸ë³´ê¸° ë²„íŠ¼ ì¶”ê°€)
        orderTableModel = new DefaultTableModel(new Object[]{"ì£¼ë¬¸ì", "ì£¼ë¬¸ ì‹œê°„", "ì£¼ë¬¸ íœ´ëŒ€í°", "ìƒì„¸ë³´ê¸°"}, 0) {
            @Override
            public boolean isCellEditable(int row, int column) {
                return false; // í¸ì§‘ ë¶ˆê°€
            }
        };
        orderTable = new JTable(orderTableModel);
        listOrders(); // ì£¼ë¬¸ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°

        // 3. ë ˆì´ì•„ì›ƒ ì„¤ì •
        JSplitPane splitPane = new JSplitPane(JSplitPane.VERTICAL_SPLIT, new JScrollPane(phoneTable), new JScrollPane(orderTable));
        splitPane.setResizeWeight(0.5); // ìœ„ìª½(íœ´ëŒ€í° ëª©ë¡) í¬ê¸°ë¥¼ 50% ì°¨ì§€í•˜ë„ë¡ ì„¤ì •

        setLayout(new BorderLayout());
        add(splitPane, BorderLayout.CENTER);

        JPanel bottomPanel = new JPanel();
        add(bottomPanel, BorderLayout.SOUTH);

        JButton addPhoneButton = new JButton("íœ´ëŒ€í° ì¶”ê°€");
        addPhoneButton.addActionListener(e -> addPhone());
        bottomPanel.add(addPhoneButton);
    }

    private void clearTables() {
        phoneTableModel.setRowCount(0);
        orderTableModel.setRowCount(0);
    }

    private void listPhones() {
        phoneTableModel.setRowCount(0);
        phoneList = phoneDao.listPhone();

        for (Phone phone : phoneList) {
            phoneTableModel.addRow(new Object[]{
                phone.getPhoneName(),
                phone.getPhoneprice(),
                phone.getPhonemaker(),
                phone.getPhoneremain()
            });
        }
    }

    private void listOrders() {
        orderTableModel.setRowCount(0);
        orderList = orderDao.listOrders(); // ì£¼ë¬¸ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°

        for (Order order : orderList) {
            JButton detailButton = new JButton("ìƒì„¸ë³´ê¸°");
            detailButton.addActionListener(e -> showOrderDetails(order));

            orderTableModel.addRow(new Object[]{
                order.getCustomerName(),
                order.getOrderTime(),
                0,
//                order.getOrderedPhoneNames(), // ì£¼ë¬¸ëœ íœ´ëŒ€í°ì˜ ì´ë¦„ì„ í•˜ë‚˜ì˜ ë¬¸ìì—´ë¡œ ì²˜ë¦¬
                detailButton // ê° í–‰ì— "ìƒì„¸ë³´ê¸°" ë²„íŠ¼ ì¶”ê°€
            });
        }
    }

    // ì£¼ë¬¸ ìƒì„¸ë³´ê¸° ì²˜ë¦¬ ë©”ì„œë“œ
    private void showOrderDetails(Order order) {
        StringBuilder details = new StringBuilder();
        details.append("ì£¼ë¬¸ì: ").append(order.getCustomerName()).append("\n");
        details.append("ì£¼ë¬¸ ì‹œê°„: ").append(order.getOrderTime()).append("\n");
        details.append("ì£¼ë¬¸ëœ íœ´ëŒ€í°:\n");

        for (Phone phone : order.getOrderedPhones()) {
            details.append("- ").append(phone.getPhoneName()).append(" (ê°€ê²©: ").append(phone.getPhoneprice()).append("ì›)\n");
        }

        JOptionPane.showMessageDialog(this, details.toString(), "ì£¼ë¬¸ ìƒì„¸ë³´ê¸°", JOptionPane.INFORMATION_MESSAGE);
    }

    private void updatePhoneInfo(int row) {
        if (row < 0 || row >= phoneList.size()) return;

        Phone phone = phoneList.get(row);
        String newPrice = phoneTableModel.getValueAt(row, 1).toString();
        String newMaker = phoneTableModel.getValueAt(row, 2).toString();
        String newRemain = phoneTableModel.getValueAt(row, 3).toString();

        try {
            phone.setPhoneprice(Integer.parseInt(newPrice));
            phone.setPhonemaker(newMaker);
            phone.setPhoneremain(Integer.parseInt(newRemain));

            int result = phoneDao.updatePhone(phone);
            if (result > 0) {
                JOptionPane.showMessageDialog(this, "íœ´ëŒ€í° ì •ë³´ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.");
            } else {
                JOptionPane.showMessageDialog(this, "ì—…ë°ì´íŠ¸ ì‹¤íŒ¨", "ì˜¤ë¥˜", JOptionPane.ERROR_MESSAGE);
            }
        } catch (NumberFormatException e) {
            JOptionPane.showMessageDialog(this, "ìˆ«ì ì…ë ¥ ì˜¤ë¥˜", "ì˜¤ë¥˜", JOptionPane.ERROR_MESSAGE);
        }
    }

    private void addPhone() {
        JTextField nameField = new JTextField();
        JTextField priceField = new JTextField();
        JTextField makerField = new JTextField();
        JTextField remainField = new JTextField();

        JPanel panel = new JPanel(new GridLayout(4, 2));
        panel.add(new JLabel("ëª¨ë¸ëª…:"));
        panel.add(nameField);
        panel.add(new JLabel("ê°€ê²©(ì›):"));
        panel.add(priceField);
        panel.add(new JLabel("ì œì¡°ì‚¬:"));
        panel.add(makerField);
        panel.add(new JLabel("ì¬ê³ :"));
        panel.add(remainField);

        int result = JOptionPane.showConfirmDialog(this, panel, "íœ´ëŒ€í° ì¶”ê°€", JOptionPane.OK_CANCEL_OPTION);
        if (result == JOptionPane.OK_OPTION) {
            try {
                String name = nameField.getText().trim();
                int price = Integer.parseInt(priceField.getText().trim());
                String maker = makerField.getText().trim();
                int remain = Integer.parseInt(remainField.getText().trim());

                Phone phone = new Phone(name, price, maker, remain);
                int insertResult = phoneDao.insertPhone(phone);

                if (insertResult > 0) {
                    JOptionPane.showMessageDialog(this, "íœ´ëŒ€í°ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    listPhones(); // ëª©ë¡ ê°±ì‹ 
                } else {
                    JOptionPane.showMessageDialog(this, "ì¶”ê°€ ì‹¤íŒ¨", "ì˜¤ë¥˜", JOptionPane.ERROR_MESSAGE);
                }
            } catch (NumberFormatException e) {
                JOptionPane.showMessageDialog(this, "ì…ë ¥ê°’ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.", "ì˜¤ë¥˜", JOptionPane.ERROR_MESSAGE);
            }
        }
    }
}
